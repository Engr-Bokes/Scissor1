{"version":3,"file":"urlService.js","sourceRoot":"","sources":["../../src/services/urlService.ts"],"names":[],"mappings":"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","sourcesContent":["import { UrlModel } from '../models/urlModel';\r\nimport { nanoid } from 'nanoid';\r\nimport { redisClient } from '../utils/redisClient';\r\nimport axios from 'axios';\r\nimport validator from 'validator'; // Import validator for URL validation\r\nimport { RedisClientType } from 'redis'; // Import the RedisClientType for type checking\r\n\r\n// Helper function to ensure redisClient is initialized\r\nconst ensureRedisClient = (): RedisClientType => {\r\n    if (!redisClient) {\r\n        throw new Error('Redis client is not initialized');\r\n    }\r\n    return redisClient;\r\n};\r\n\r\n// Function to create a short URL\r\nexport const createShortUrl = async (originalUrl: string, userId: string, customUrl?: string) => {\r\n    // Validate the original URL\r\n    if (!validator.isURL(originalUrl, { protocols: ['http', 'https'], require_protocol: true })) {\r\n        throw new Error('Invalid URL provided');\r\n    }\r\n\r\n    const urlCode = customUrl || nanoid(7);\r\n    const baseUrl = process.env.BASE_URL || 'https://scissor-backend.hostless.app';\r\n    const shortUrl = `${baseUrl}/${urlCode}`;\r\n\r\n    const urlData = new UrlModel({ originalUrl, shortUrl, urlCode, user: userId });\r\n    await urlData.save();\r\n\r\n    await ensureRedisClient().set(urlCode, originalUrl);\r\n\r\n    const qrCode = await generateQrCode(shortUrl);\r\n\r\n    return { shortUrl, qrCode };\r\n};\r\n\r\n// Function to get analytics for a short URL\r\nexport const getAnalytics = async (code: string) => {\r\n    const url = await UrlModel.findOne({ urlCode: code });\r\n\r\n    if (url) {\r\n        return {\r\n            originalUrl: url.originalUrl,\r\n            shortUrl: url.shortUrl,\r\n            clicks: url.clicks,\r\n            lastAccessed: url.lastAccessed,\r\n        };\r\n    }\r\n\r\n    throw new Error('URL not found');\r\n};\r\n\r\n// Function to retrieve the original URL by short ID (urlCode)\r\nexport const getUrlByShortId = async (urlCode: string): Promise<string | null> => {\r\n    // Check if the URL is cached in Redis\r\n    const cachedUrl = await ensureRedisClient().get(urlCode);\r\n    if (cachedUrl) {\r\n        return cachedUrl;\r\n    }\r\n\r\n    // If not found in Redis, check the database\r\n    const urlRecord = await UrlModel.findOne({ urlCode });\r\n    if (urlRecord) {\r\n        // Cache the original URL in Redis for future requests\r\n        await ensureRedisClient().set(urlCode, urlRecord.originalUrl);\r\n        return urlRecord.originalUrl;\r\n    }\r\n\r\n    return null;\r\n};\r\n\r\n// Function to generate a QR code for the short URL\r\nconst generateQrCode = async (url: string): Promise<string> => {\r\n    try {\r\n        const response = await axios.get('https://api.qrserver.com/v1/create-qr-code/', {\r\n            params: {\r\n                data: encodeURIComponent(url),\r\n                size: '150x150',\r\n            },\r\n            responseType: 'arraybuffer',\r\n        });\r\n        return response.config.url as string;\r\n    } catch (error) {\r\n        console.error('Error generating QR code:', error);\r\n        throw new Error('Failed to generate QR code');\r\n    }\r\n};\r\n"]}